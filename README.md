# Time‑Locked Wallet (Solana + Anchor)

A minimal, production‑minded time‑locked wallet on Solana with a simple Next.js frontend. This repository is intended as a complete submission for the “Build a Time‑Locked Wallet” bounty.

- Cluster: Devnet by default
- Program: Anchor 0.31
- Frontend: Next.js + Anchor client + Wallet Adapter

---

## What It Does

- Lock SOL into a PDA until a chosen unlock timestamp (enforced on‑chain)
- Optional administrator (authority) with granular rights
- Withdraw to the designated receiver after the unlock time
- Simple web UI: Create vault, Admin (optional edits), and Withdraw

Bonus‑ready extensions are outlined below (USDC/SPL support, countdown).

---

## Quick Start

- Requirements
  - Solana CLI (2.2+), Anchor CLI (0.31+), Rust stable
  - Node.js 18+ and a package manager (npm/yarn/pnpm) for the frontend

- 1) Build and deploy the program to Devnet
  ```bash
  cd Time-locked-wallet
  anchor build
  anchor deploy
  # Note the Program Id printed or use, e.g. 4ZGMpP8pQyC9FWQ1J1W9EMR3GvyTWuY5sDotgRqadXAb
  ```

- 2) Run the frontend (Devnet)
  ```bash
  cd frontend
  # optional: export NEXT_PUBLIC_RPC_URL to a dedicated Devnet RPC
  # echo "NEXT_PUBLIC_RPC_URL=https://your-devnet-rpc" > .env.local
  npm install
  npm run dev
  # open http://localhost:3000
  ```

- 3) Use the app
  - Create Vault tab: enter amount (SOL), unlock time (UTC‑first controls), receiver pubkey, and optional authority/rights
  - Admin tab: list vaults for which your wallet is authority; update receiver or unlock time (if rights allow)
  - Withdraw tab: list vaults where you are receiver; withdraw after unlock
  - After withdrawal, the creator can delete the vault (close_vault) to reclaim rent from the "Vaults Created" list

---

## Program Details (Anchor)

- Location: `programs/time-locked-wallet`
- Program ID must match in three places:
  1) `programs/time-locked-wallet/src/lib.rs` via `declare_id!("...")`
  2) `Anchor.toml` under `[programs.<cluster>].time_locked_wallet`
  3) `target/deploy/time_locked_wallet-keypair.json` (generated by Anchor)

- PDA
  - Vault account: seeds = `[b"vault", creator_pubkey, seed_u64_le]`
  - Stores seed and bump on chain; later instructions don’t require passing `seed` again

- Accounts layout
  ```text
  TimeLock {
    creator: Pubkey,
    authority: Option<Pubkey>,   // None => immutable admin; Some(pubkey) => admin enabled
    receiver: Pubkey,            // withdrawer after unlock
    amount: u64,                 // lamports locked
    unlock_timestamp: i64,       // unix seconds
    seed: u64,                   // FE‑generated; saved on chain
    authority_rights: u8,        // bitmask: 1=set_receiver, 2=set_duration
    bump: u8,
  }
  ```

- Instructions
  - initialize_lock(amount: u64, unlock_timestamp: i64, authority: Option<Pubkey>, receiver: Pubkey, seed: u64, authority_rights: u8)
    - Creates vault PDA and transfers `amount` lamports from the creator to the vault
    - Validations: `amount > 0`, `unlock_timestamp > now`; if `authority` is None then `authority_rights` must be 0
  - withdraw()
    - Only the `receiver` (signer) can withdraw and only after `now >= unlock_timestamp`
    - Transfers `amount` to `receiver` and sets `amount = 0`. To reclaim rent and delete the account, call `close_vault()` (not automatic).
  - set_receiver(new_receiver: Pubkey)
    - Only `authority` with right bit `1` (if authority is Some)
  - set_duration(new_unlock_timestamp: i64)
    - Only `authority` with right bit `2` (if authority is Some)
  - close_vault()
    - Only the `creator` can close the vault account, and only when `amount == 0`. This returns the remaining rent lamports to the creator.

---

## Frontend Details (Next.js)

- Location: `frontend`
- Wallet: Phantom, Solflare, Backpack via `@solana/wallet-adapter`
- RPC endpoint (Devnet):
  - Defaults to `https://api.devnet.solana.com`
  - Override with `NEXT_PUBLIC_RPC_URL` (recommended to avoid 429 on public RPC)
- Program ID in client:
  - Single source of truth in `frontend/src/utils/anchor.ts` (`PROGRAM_ID`)
  - Anchor client is instantiated as `new Program(idlWithAddress, provider)` (Anchor 0.31 browser build)
- UX notes
  - Unlock time inputs are UTC‑first and split into Date / Time / Timezone to avoid timezone confusion
  - Admin/Withdraw lists are cached after first load; subsequent refresh is manual and throttled with a 5s cooldown

---

## Deploying the Frontend

- Vercel (recommended)
  - Root directory: `frontend`
  - Build command: `npm run build`
  - Environment: set `NEXT_PUBLIC_RPC_URL` (your Devnet RPC) if available
  - Program ID must match on chain (see Program Details)
- Self‑host
  ```bash
  cd frontend
  npm install
  npm run build
  npm run start -- -H 0.0.0.0 -p 3000   # behind a reverse proxy for HTTPS
  ```

---

## Rate Limits (429) And How We Avoid Them

Public RPCs enforce quotas, especially for `getProgramAccounts`. This app:
- Caches lists across tabs (only fetches once after wallet connects)
- Uses server‑side memcmp filters to minimize payloads
- Adds a 5s refresh cooldown to avoid request bursts
- Allows `NEXT_PUBLIC_RPC_URL` to use a dedicated RPC with higher quotas

If you still see 429 on heavy traffic, use a provider endpoint (Helius/QuickNode/Alchemy/Ankr) and/or add subscriptions instead of polling.

---

## Troubleshooting

- Program ID mismatch
  - Ensure `declare_id!`, `Anchor.toml`, and `target/deploy/time_locked_wallet-keypair.json` all match
  - Rebuild and redeploy: `anchor build && anchor deploy`

- Anchor Program constructor error (browser)
  - Use `new Program(idlWithAddress, provider)`; passing `programId` as the 2nd argument is for the Node variant

- “_bn” / PublicKey type errors
  - Pass `PublicKey` or base58 `string` where required
  - For optional pubkeys, pass `null` (not `undefined`)
  - Convert BN/BigInt explicitly for seeds: `Buffer.from(seedBN.toArray('le', 8))`

- InvalidUnlockTime
  - Unlock must be in the future; UI enforces this and uses UTC‑first inputs

- 429 Too Many Requests
  - Use a dedicated RPC via `NEXT_PUBLIC_RPC_URL`
  - Rely on manual refresh (cooldown) instead of tab‑switch fetches

---

## Directory Layout

```text
Time-locked-wallet/
├─ Anchor.toml
├─ programs/
│  └─ time-locked-wallet/
│     ├─ src/lib.rs                 # Anchor program
│     └─ Cargo.toml
├─ target/
│  └─ idl/time_locked_wallet.json   # IDL (generated)
├─ frontend/
│  ├─ app/
│  │  ├─ page.tsx                   # UI (Create/Admin/Withdraw)
│  │  └─ providers.tsx              # Wallet + connection provider
│  └─ src/utils/anchor.ts           # Anchor client + PROGRAM_ID
├─ tests/                           # Example tests (time_locked_wallet.spec.ts is up-to-date; legacy file kept for reference)
└─ README.md                        # This file
```

---

## Bonus Extensions (Optional)

- USDC/SPL token support
  - Add token mint + token accounts; use `anchor_spl::token` CPIs for transfers
  - Frontend toggle between SOL / USDC, display with correct decimals
- Countdown timer in UI
  - Show HH:MM:SS until unlock; update every second
- Minimal test suite
  - Mocha/Chai or Anchor tests covering initialize/withdraw and admin edits

---

## Submission Checklist

- Program enforces lock on‑chain
- Frontend can create + view + withdraw
- Public repo with clear README and run instructions
- Devnet deployment + program ID included
- Optional: hosted demo URL and a custom RPC endpoint configured

---

## Notes

This is an educational sample. It is not audited. Use at your own risk.
